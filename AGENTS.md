# Reactive Agents — Agent Workflow Guide

> Instructions for AI agents working on this codebase. Read this before making changes.

---

## Golden Rules

1. **Read before writing.** Always read existing files before editing. Understand patterns before introducing new code.
2. **Follow Effect-TS patterns.** Load the `effect-ts-patterns` skill. No `throw`, no raw `await`, no plain interfaces.
3. **Keep docs truthful.** Every code change that affects public API, test counts, or capabilities must update documentation (see Documentation Workflow below).
4. **Test everything.** New services need tests. New features need integration tests. Run `bun test` before declaring work complete.
5. **One concern per commit.** Don't mix unrelated changes.

---

## Development Workflow

### Before Starting Work

1. Read `CLAUDE.md` for project status, build commands, and architecture overview
2. Read the relevant spec in `spec/docs/` for the feature you're implementing
3. Check `spec/docs/14-v0.5-comprehensive-plan.md` for current sprint context
4. Load relevant skills (`effect-ts-patterns`, `architecture-reference`, `llm-api-contract`)

### Build & Test Cycle

```bash
bun install              # After dependency changes
bun test                 # Run full suite (must pass before any PR)
bun run build            # Build all packages (ESM + DTS, must compile clean)
```

### After Completing a Feature

Run this checklist:

- [ ] All tests pass (`bun test`)
- [ ] Build succeeds (`bun run build`)
- [ ] Documentation updated (see below)
- [ ] No new `TODO`/`FIXME` without a tracking issue
- [ ] Pattern compliance verified (`/review-patterns <changed-files>`)

---

## Documentation Workflow

### When to Update What

| Trigger | Files to Update |
|---------|----------------|
| **New package created** | `CLAUDE.md` (package map + spec index), `README.md` (packages table), `CHANGELOG.md`, architecture-reference skill, docs site sidebar |
| **New/changed builder method** | `README.md` (quick start + capabilities), `apps/docs/src/content/docs/reference/builder-api.md`, `CLAUDE.md` (architecture section) |
| **New CLI command** | `README.md` (CLI section), `apps/docs/src/content/docs/reference/cli.md`, `CLAUDE.md` (CLI section) |
| **Test count changed** | `CLAUDE.md` (build commands section), `README.md` (development section) |
| **New reasoning strategy** | `README.md` (strategies table), `apps/docs/src/content/docs/guides/reasoning.md` |
| **New LLM provider** | `README.md` (providers table), `apps/docs/src/content/docs/features/llm-providers.md`, `CLAUDE.md` (env vars if needed) |
| **New feature page needed** | `apps/docs/src/content/docs/features/<name>.md` or `guides/<name>.md` |
| **API signature change** | Search all docs for old signature and update: `grep -r "oldMethod" apps/docs/` |
| **Version bump / release** | `CHANGELOG.md` (new entry), all `package.json` files, `CLAUDE.md` status |

### CHANGELOG Format

Follow [Keep a Changelog](https://keepachangelog.com/). Each release entry must include:

```markdown
## [X.Y.Z] — YYYY-MM-DD

### Added
- Feature descriptions with package scope

### Changed
- Package version bumps with context

### Fixed
- Bug fixes with root cause

### Stats
- N tests across M files (was P/Q)
```

### Docs Site (Starlight/Astro)

Location: `apps/docs/`

```bash
cd apps/docs && npx astro dev    # Preview locally
cd apps/docs && npx astro build  # Build for production
```

Key files:
- `astro.config.mjs` — sidebar structure (autogenerated from directories)
- `src/content/docs/` — all documentation pages
- `src/content/config.ts` — content collection config (NOT `content.config.ts`)
- Must use `legacy: { collections: true }` for Bun workspace compatibility

### README.md

The README is the public face. Keep it accurate:
- Badge row at top
- Architecture diagram reflects actual layers
- Packages table lists all published packages
- Test counts match reality
- Code examples use actual API signatures (test them!)

### ROADMAP.md

Root `ROADMAP.md` is the authoritative forward-looking plan. Update when:
- A milestone ships (move from "target" to "✅ Released")
- Scope changes for a future version
- New competitive intelligence changes priorities

---

## Multi-Agent Coordination

### Team Structure

For large features (new packages, cross-cutting changes):

| Role | Does | Doesn't |
|------|------|---------|
| **Lead** | Plans, assigns, reviews, integrates | Write package code directly |
| **Builder** | Implements packages using skills | Make cross-package architectural decisions |
| **Tester** | Writes tests, validates coverage | Skip pattern review |

### Parallelization Rules

- Packages with no dependency relationship can be built in parallel
- Always validate gate dependencies before starting dependent work:
  ```
  core → llm-provider → {memory, tools, reasoning} → runtime
  ```
- Run workspace-wide `bun run build` after each package completes
- Use `/validate-build <pkg>` before moving to dependent packages

### Communication Protocol

When handing off between agents:
1. State what was completed (files created/modified)
2. State what was verified (tests passed, build clean)
3. State what's next (dependent work now unblocked)
4. Flag any known issues or deviations from spec

---

## Package Creation Checklist

When creating a new package (e.g., `@reactive-agents/a2a`):

1. [ ] Create `packages/<name>/package.json` with correct deps
2. [ ] Create `packages/<name>/tsconfig.json` extending root
3. [ ] Create `packages/<name>/tsup.config.ts` for build
4. [ ] Implement `src/types.ts`, `src/errors.ts`
5. [ ] Implement services following Effect-TS patterns
6. [ ] Create `src/runtime.ts` with layer factory
7. [ ] Create `src/index.ts` with all public exports
8. [ ] Write tests in `tests/`
9. [ ] Add to root `package.json` workspaces if needed
10. [ ] Add to root build script order
11. [ ] Run `bun install` to link workspace
12. [ ] Run `bun test packages/<name>` — all pass
13. [ ] Run `bun run build` — workspace compiles clean
14. [ ] Update `CLAUDE.md` package map
15. [ ] Update `README.md` packages table
16. [ ] Update architecture-reference skill dependency graph
17. [ ] Add spec file reference to `CLAUDE.md` spec index

---

## Quality Gates

### Before Any PR

| Check | Command | Must |
|-------|---------|------|
| Tests pass | `bun test` | 100% green |
| Build clean | `bun run build` | No errors |
| Pattern compliance | `/review-patterns <files>` | 8/8 pass |
| Docs accurate | Manual review | No stale examples |

### Before Any Release

| Check | Details |
|-------|---------|
| All above | Plus full integration test |
| CHANGELOG | New version entry with all sections |
| Package versions | All bumped consistently |
| Docs site builds | `cd apps/docs && npx astro build` |
| README current | Stats, packages, examples all accurate |
| ROADMAP updated | Shipped items marked, new targets set |

---

## Key File Paths

| Category | Path |
|----------|------|
| Specs | `spec/docs/` |
| Skills | `.claude/skills/` |
| Packages | `packages/{core,llm-provider,memory,...}/` |
| CLI | `apps/cli/` |
| Docs | `apps/docs/src/content/docs/` |
| Examples | `apps/examples/` |
| CI | `.github/workflows/` |
| v0.5 Plan | `spec/docs/14-v0.5-comprehensive-plan.md` |

---

## Common Pitfalls

1. **`serviceOption` returns `Option`** — use `Option.isSome()` + `.value`, not direct access
2. **`ContextWindowManager.truncate()`** not `buildContext()` — buildContext requires systemPrompt
3. **Gemini SDK is `@google/genai`** not `@google/generative-ai`
4. **`mock.module()` in Bun** only intercepts ES `import()`, not CJS `require()`
5. **ReasoningService.execute** takes single params object, not positional args
6. **Starlight content config** must be `src/content/config.ts` not `src/content.config.ts`
7. **`workspace:^`** for internal deps (not `workspace:*`) to fix CI DTS builds
